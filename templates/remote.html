<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle Remoto</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            background: #000;
            overflow: hidden;
            touch-action: none;
            font-family: monospace;
        }

        #screen {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
            cursor: none;
        }

        #status {
            position: fixed;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            z-index: 10;
        }

        #loading {
            position: absolute;
            inset: 0;
            background: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            z-index: 5;
        }
    </style>
</head>

<body>

    <div id="loading">Carregando tela remota...</div>
    <img id="screen" draggable="false">
    <div id="status">Conectando...</div>
    <button id="stopBtn" style="
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 100;
    padding: 8px 16px;
    background: #c00;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
">Parar Streaming</button>

    <script>
        const socket = io();
        const screenImg = document.getElementById("screen");
        const statusBar = document.getElementById("status");
        const loading = document.getElementById("loading");
        const stopBtn = document.getElementById("stopBtn");

        stopBtn.addEventListener("click", () => {
            socket.emit("stop_stream");
            statusBar.textContent = "Streaming parado manualmente";
            stopBtn.disabled = true;
            stopBtn.textContent = "Parado";
        });

        let lastX = 0, lastY = 0;
        let isConnected = false;

        socket.on("connect", () => {
            statusBar.textContent = "Conectado";
            socket.emit("start_stream");
            isConnected = true;
        });

        socket.on("disconnect", () => {
            statusBar.textContent = "Desconectado";
            loading.style.display = "flex";
            isConnected = false;
        });

        socket.on("error", (data) => {
            statusBar.textContent = data.message || "Erro";
            statusBar.style.color = "#f33";
        });

        socket.on("screen", (data) => {
            screenImg.src = "data:image/jpeg;base64," + data;
            if (loading.style.display !== "none") {
                loading.style.display = "none";
            }
        });

        function getCoords(e) {
            const rect = screenImg.getBoundingClientRect();
            return {
                x: Math.round((e.clientX - rect.left) * (screenImg.naturalWidth / rect.width)),
                y: Math.round((e.clientY - rect.top) * (screenImg.naturalHeight / rect.height))
            };
        }

        function send(data) {
            if (!isConnected) return;
            socket.emit("command", data);
        }

        // Movimento do mouse
        screenImg.addEventListener("pointermove", (e) => {
            const pos = getCoords(e);
            if (Math.hypot(pos.x - lastX, pos.y - lastY) > 3) {
                send({ type: "move", x: pos.x, y: pos.y });
                lastX = pos.x;
                lastY = pos.y;
            }
        });

        // Clique esquerdo
        screenImg.addEventListener("pointerdown", (e) => {
            if (e.pointerType === "mouse" && e.button === 2) return; // ignora botão direito aqui
            const pos = getCoords(e);
            send({ type: "mouseDown", x: pos.x, y: pos.y });
        });

        screenImg.addEventListener("pointerup", (e) => {
            if (e.pointerType === "mouse" && e.button === 2) return;
            const pos = getCoords(e);
            send({ type: "mouseUp", x: pos.x, y: pos.y });
        });

        // Botão direito
        screenImg.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            const pos = getCoords(e);
            send({ type: "mouseDown", x: pos.x, y: pos.y, button: "right" });
            setTimeout(() => {
                send({ type: "mouseUp", x: pos.x, y: pos.y, button: "right" });
            }, 80);
        });

        // Scroll
        screenImg.addEventListener("wheel", (e) => {
            e.preventDefault();
            send({ type: "scroll", deltaY: e.deltaY });
        });

        // Teclado
        window.addEventListener("keydown", (e) => {
            if (e.repeat) return;
            send({ type: "key", key: e.key });
        });

        let lastClick = 0;
        screenImg.addEventListener("click", (e) => {
            const now = Date.now();
            if (now - lastClick < 300) {
                send({ type: "doubleClick" });
            }
            lastClick = now;
        });
    </script>
</body>

</html>